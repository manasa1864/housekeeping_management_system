<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Reports — Housekeeping</title>

<style>
  :root{
    --bg:#0b1116;--side:#0e141a;--panel:#111922;--line:rgba(255,255,255,.08);
    --ink:#e9f1f8;--mut:#a6b2bf;--brand:#2b74ff;--brand2:#1a59e6
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 Inter,system-ui}

  .shell{display:grid;grid-template-columns:240px 1fr;min-height:100%}
  .side{background:var(--side);border-right:1px solid var(--line);padding:18px}
  .brand{font-weight:800;margin:6px 4px 14px}
  .nav a{display:block;color:#dfe7f1;text-decoration:none;padding:10px 12px;border-radius:10px}
  .nav a.active,.nav a:hover{background:rgba(255,255,255,.08)}

  main{padding:24px;max-width:1200px;margin:0 auto}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;margin-bottom:12px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
  .section-title{font-weight:800;margin:0 0 8px}
  .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:800;color:#fff;background:linear-gradient(180deg,var(--brand),var(--brand2));cursor:pointer}

  .intro{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .small{color:var(--mut);font-size:12px}
  .grid{display:grid;gap:12px;grid-template-columns:1.2fr .8fr}
  .stack{display:grid;gap:12px}

  /* Charts follow theme and are taller (like Admin) */
  canvas{display:block;width:100% !important;height:300px !important;background:var(--panel);border:1px solid var(--line);border-radius:12px}

  /* A4 capture area for PDF */
  .pdf-sheet{
    width:794px; /* A4 @ 96dpi */
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:12px;
    padding:16px;
    margin:0 auto;
  }
  .pdf-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .pdf-title{font-weight:900;margin:0}
  .mut{color:var(--mut)}
  .top3{border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .top3 .row{display:grid;grid-template-columns:1fr 100px;gap:10px;padding:10px;border-bottom:1px solid var(--line)}
  .top3 .row:last-child{border-bottom:0}
  .para{color:var(--mut);font-size:12px;line-height:1.6;margin-top:8px}
  @media (max-width:1100px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="shell">
  <aside class="side">
    <div class="brand">Housekeeping</div>
    <nav class="nav">
      <a href="admin.html">Dashboard</a>
      <a href="rooms.html">Rooms</a>
      <a href="reports.html" class="active">Reports</a>
      <a href="settings.html">Settings</a>
    </nav>
  </aside>

  <main>
    <div class="card intro">
      <div>
        <div class="section-title" style="margin:0">Export monthly snapshot as PDF</div>
        <div class="small">Includes the 3 dashboard charts + Top-3 staff + a short note.</div>
      </div>
      <button id="btnExport" class="btn">Export PDF</button>
    </div>

    <!-- Visible preview (also captured to PDF) -->
    <div id="pdfArea" class="pdf-sheet">
      <div class="pdf-head">
        <h2 id="reportTitle" class="pdf-title">Housekeeping — Performance Snapshot</h2>
        <div class="mut" id="reportDate"></div>
      </div>

      <div class="small" id="hotelNameLine" style="margin-bottom:8px"></div>

      <div class="grid">
        <div class="stack">
          <div>
            <div class="small" style="margin-bottom:6px">Task Completion Trends (Mon–Sun)</div>
            <canvas id="cTrend"></canvas>
          </div>
          <div>
            <div class="small" style="margin-bottom:6px">Staff — Assigned Tasks</div>
            <canvas id="cStaff"></canvas>
          </div>
        </div>
        <div class="stack">
          <div>
            <div class="small" style="margin-bottom:6px">Room Occupancy Status</div>
            <canvas id="cDonut"></canvas>
          </div>

          <div>
            <div class="small" style="margin:8px 0 6px">Top 3 Best Performing Staff</div>
            <div id="top3" class="top3"></div>
          </div>
        </div>
      </div>

      <p class="para">
        Housekeepers are the quiet engine of guest satisfaction. Their attention to cleanliness, safety, and
        quick turnarounds protects brand reputation and keeps operations running. This report recognizes their
        consistency and teamwork — the foundation on which great hospitality is built.
      </p>
    </div>
  </main>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
(() => {
  /* -------- storage helpers -------- */
  const LS = {
    get(k, fb){ try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } }
  };
  const KEY_STAFF = "hk_staff";
  const KEY_TASKS = "hk_tasks_v1"; // { tasks: [...] }
  const ROOMS_AGG_KEY = "hms_rooms_occupancy_v1";

  /* -------- theme colors & helpers (match Admin) -------- */
  const cs = getComputedStyle(document.documentElement);
  const INK   = cs.getPropertyValue("--ink").trim()   || "#e9f1f8";
  const MUT   = cs.getPropertyValue("--mut").trim()   || "#a6b2bf";
  const BRAND = cs.getPropertyValue("--brand").trim() || "#2b74ff";
  const BRAND2= cs.getPropertyValue("--brand2").trim()|| "#1a59e6";

  const baseOpts = {
    responsive:true, maintainAspectRatio:false, animation:{duration:300},
    plugins:{
      legend:{ labels:{ color:INK, boxWidth:10, boxHeight:10, padding:12, font:{weight:"700"} }},
      tooltip:{ backgroundColor:"#0b1324", titleColor:INK, bodyColor:INK, borderColor:"rgba(255,255,255,.14)", borderWidth:1, padding:10, displayColors:false }
    },
    scales:{
      x:{ grid:{ color:"rgba(255,255,255,.12)" }, ticks:{ color:INK, font:{weight:"700"} }},
      y:{ grid:{ color:"rgba(255,255,255,.12)" }, ticks:{ color:INK, font:{weight:"600"} }}
    }
  };

  function hexToRgba(hex,a=1){
    const h=hex.replace("#",""); const n=parseInt(h.length===3?h.split("").map(x=>x+x).join(""):h,16);
    const r=(n>>16)&255,g=(n>>8)&255,b=n&255; return `rgba(${r},${g},${b},${a})`;
  }
  function grad(ctx, area, from=BRAND, to=BRAND2, aTop=1, aBot=1){
    const g = ctx.createLinearGradient(0, area.bottom, 0, area.top);
    g.addColorStop(0, hexToRgba(from,aBot)); g.addColorStop(1, hexToRgba(to,aTop)); return g;
  }

  /* -------- Header (date + hotel name) -------- */
  (function(){
    const d = new Date();
    const nice = d.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
    document.getElementById("reportDate").textContent = nice;

    // Try multiple keys used across versions
    let hotel = "";
    const prof = LS.get("hk:profile") || LS.get("hk_settings_profile");
    if (prof && prof.hotelName) hotel = prof.hotelName;
    if (!hotel) hotel = LS.get("hotelName",""); // legacy simple key
    if (hotel) document.getElementById("hotelNameLine").textContent = "Hotel: " + hotel;
  })();

  /* -------- Accessors to mirror Admin -------- */
  function getTasksArray(){
    const blob = LS.get(KEY_TASKS, { tasks: [] });
    if (Array.isArray(blob)) return blob;               // legacy
    if (Array.isArray(blob.tasks)) return blob.tasks;   // canonical
    return [];
  }

  /* -------- Charts + Top3 (aligned to Admin) -------- */
  function buildCharts(){
    // Task Trend (gradient + fill)
    const ctxT = document.getElementById("cTrend").getContext("2d");
    const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    const staffCount = (LS.get(KEY_STAFF, [])||[]).length || 1;
    const base = 10 + staffCount * 4;
    const completed = days.map((_,i)=> Math.max(2, Math.round(base + (Math.sin(i*1.3)*3))));
    const pending   = completed.map(v=> Math.max(1, Math.round(v*0.35)));
    new Chart(ctxT, {
      type:"line",
      data:{ labels:days, datasets:[
        {
          label:"Completed",
          data:completed,
          tension:.35,
          borderColor(c){ const ca=c.chart?.chartArea; return ca?grad(c.chart.ctx, ca, BRAND, BRAND2, 1, 1):BRAND; },
          backgroundColor(c){ const ca=c.chart?.chartArea; return ca?grad(c.chart.ctx, ca, BRAND, BRAND2, .28, .08):hexToRgba(BRAND,.2); },
          fill:true
        },
        {
          label:"Pending",
          data:pending,
          tension:.35,
          borderColor: hexToRgba(MUT, .9),
          backgroundColor: hexToRgba(MUT, .15),
          fill:true
        }
      ]},
      options:{ ...baseOpts, plugins:{...baseOpts.plugins, legend:{display:false}} }
    });

    // Rooms Donut (colors match Admin)
    const ctxD = document.getElementById("cDonut").getContext("2d");
    const a = LS.get(ROOMS_AGG_KEY, {occupied:0,vacant:0,needs:0});
    new Chart(ctxD, {
      type:"doughnut",
      data:{ labels:["Occupied","Vacant","Needs"], datasets:[{
        data:[a.occupied||0,a.vacant||0,a.needs||0],
        backgroundColor:[BRAND, hexToRgba(MUT,.45), "#ff7070"],
        borderColor: hexToRgba("#000", .18),
        borderWidth: 1,
        hoverOffset:6
      } ]},
      options:{ ...baseOpts, cutout:"68%", plugins:{...baseOpts.plugins, legend:{position:"bottom", labels:{color:INK}} } }
    });

    // Staff Bar — show ASSIGNED tasks of any status (like Admin fix)
    const ctxS = document.getElementById("cStaff").getContext("2d");
    const tasks = getTasksArray();
    const staff = LS.get(KEY_STAFF, []);
    const counts = {};
    for (const t of tasks) if (t.assignee) counts[t.assignee]=(counts[t.assignee]||0)+1;

    // Fallback to staff.assigned if no data
    if (Object.values(counts).every(v=>!v) && staff?.length){
      for (const s of staff) counts[s.name] = s.assigned ? Number(s.assigned) : 0;
    }

    const names = [...new Set([...staff.map(s=>s.name), ...Object.keys(counts)])].filter(Boolean);
    const values = names.map(n => counts[n]||0);
    const suggestedMax = Math.max(5, Math.max(0,...values)+2);

    new Chart(ctxS, {
      type:"bar",
      data:{ labels:names, datasets:[{
        label:"Assigned",
        data:values,
        borderWidth:0, borderRadius:10, barThickness:26,
        backgroundColor(c){ const ca=c.chart?.chartArea; return ca?grad(c.chart.ctx, ca):BRAND; }
      }]},
      options:{ ...baseOpts, plugins:{...baseOpts.plugins, legend:{display:false}},
        scales:{ x:{...baseOpts.scales.x, ticks:{...baseOpts.scales.x.ticks, maxRotation:0, autoSkip:true}},
                 y:{...baseOpts.scales.y, suggestedMax: suggestedMax } } }
    });

    // Top-3: prefer Completed counts; if none, fall back to Assigned
    const completedCounts = {};
    for (const t of tasks) if (t.status==="Completed" && t.assignee) completedCounts[t.assignee]=(completedCounts[t.assignee]||0)+1;
    let topSource = completedCounts;
    if (Object.values(completedCounts).every(v=>!v)) topSource = counts; // fallback

    const pairs = [...new Set([...staff.map(s=>s.name), ...Object.keys(topSource)])]
      .filter(Boolean).map(n=>({name:n, done:topSource[n]||0}))
      .sort((a,b)=>b.done-a.done).slice(0,3);

    const box = document.getElementById("top3");
    if (!pairs.length){
      box.innerHTML = '<div class="row"><div>No data yet</div><div>—</div></div>';
    } else {
      box.innerHTML = pairs.map(p=>`<div class="row"><div>${p.name}</div><div style="text-align:right;font-weight:800">${p.done}</div></div>`).join("");
    }
  }
  buildCharts();

  /* -------- Export to PDF -------- */
  document.getElementById("btnExport").addEventListener("click", async () => {
    const area = document.getElementById("pdfArea");
    const canvas = await html2canvas(area, {backgroundColor:null, scale:2, useCORS:true});
    const imgData = canvas.toDataURL("image/png");

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({orientation:"portrait", unit:"px", format:"a4"});
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    const ratio = canvas.height / canvas.width;
    const imgW = pageW - 40;  // margins
    const imgH = imgW * ratio;

    if (imgH <= pageH - 40){
      pdf.addImage(imgData, "PNG", 20, 20, imgW, imgH);
    } else {
      // Long content → scale to fit height
      const fitH = pageH - 40;
      const fitW = fitH / ratio;
      pdf.addImage(imgData, "PNG", (pageW-fitW)/2, 20, fitW, fitH);
    }
    pdf.save("Housekeeping-Report.pdf");
  });

  /* -------- LIVE AUTO-UPDATE: refresh on admin/dept changes -------- */
  window.addEventListener("storage", (e) => {
    if (
      e.key === "hk_tasks_v1" ||
      e.key === "hk_staff" ||
      e.key === "hms_rooms_occupancy_v1" ||
      e.key === "hk_tasks_pulse_v1" ||
      e.key === "hk_staff_pulse_v1" ||
      e.key === "rooms-updated"
    ) {
      location.reload();
    }
  });
})();
</script>
<script src="logout.js"></script>
</body>
</html>
